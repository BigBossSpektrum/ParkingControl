{% extends 'app_page/base.html' %}
{% block title %}Panel Principal{% endblock %}

{% block left_section %}
    {# Formulario de salida #}
    <div class="card bg-dark text-success border-success shadow-lg" style="width: 100%; max-width: 480px;">
        <div class="card-body px-5 py-4">
            <h2 class="card-title text-center mb-4">
                <i class="bi bi-box-arrow-right me-2"></i>Registrar Salida
            </h2>
            {% if mensaje_salida %}<div class="alert alert-info">{{ mensaje_salida }}</div>{% endif %}
            <form method="post" id="salidaForm" onsubmit="return false;">
                {% csrf_token %}
                <div class="mb-4">
                    <label for="id_codigo" class="form-label">
                        <i class="bi bi-upc-scan me-2"></i>Escanee el código QR o ingrese la cédula o ID
                    </label>
                    <input type="text" 
                           name="codigo" 
                           id="id_codigo" 
                           class="form-control" 
                           placeholder="Escanee QR o ingrese cédula/ID..."
                           autocomplete="off"
                           autofocus>
                    <div class="form-text text-muted mt-2">
                        <small><i class="bi bi-lightbulb me-1"></i>Campo principal del sistema - se enfoca automáticamente para facilitar el escaneo</small>
                    </div>
                </div>
                <button type="submit" class="btn btn-success w-100 py-2" id="submitSalidaBtn">
                    <i class="bi bi-box-arrow-right me-2"></i>Registrar Salida
                </button>
            </form>
        </div>
    </div>

{% endblock %}

{% block right_section %}
    {# Formulario de registro de usuario #}
    <div class="card bg-dark text-success border-success shadow-lg" style="width: 100%; max-width: 480px;">
        <div class="card-body px-5 py-4">
            <h2 class="card-title text-center mb-4">
                <i class="bi bi-person-plus-fill me-2"></i>Registro de Cliente
            </h2>
            {% if message_success %}<div class="alert alert-success">{{ message_success }}</div>{% endif %}
            <form method="post" id="registroForm" onsubmit="return false;">
                {% csrf_token %}
                {% for field in registro_form.visible_fields %}
                    {% if field.name == 'matricula_inicio' %}
                        <div class="mb-4">
                            <label class="form-label">Matrícula <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" name="matricula_inicio" maxlength="3" minlength="3" class="form-control form-control-sm text-uppercase" style="max-width:60px;" value="{{ registro_form.matricula_inicio.value|default_if_none:'' }}" required>
                                <span class="input-group-text" style="max-width:24px;">-</span>
                                <input type="text" name="matricula_fin" maxlength="3" minlength="3" class="form-control form-control-sm text-uppercase" style="max-width:60px;" value="{{ registro_form.matricula_fin.value|default_if_none:'' }}" required>
                            </div>
                            <div class="form-text text-success">Campo obligatorio</div>
                            {% if registro_form.matricula_inicio.help_text %}
                                <div class="form-text text-success">{{ registro_form.matricula_inicio.help_text }}</div>
                            {% endif %}
                            {% for error in registro_form.matricula_inicio.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                            {% for error in registro_form.matricula_fin.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% elif field.name != 'tiempo_parking' and field.name != 'matricula_fin' %}
                        <div class="mb-4">
                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                            {{ field }}
                            {% if field.help_text %}
                                <div class="form-text text-success">{{ field.help_text }}</div>
                            {% endif %}
                            {% for error in field.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endfor %}
                <button type="submit" class="btn btn-success w-100 py-2 mt-2" id="submitRegistroBtn">
                    <i class="bi bi-save me-1"></i>Registrar Cliente
                </button>
            </form>
            <a href="{% url 'lista_clientes' %}" class="btn btn-dark w-100 py-2 mt-3">
                <i class="bi bi-list-ul me-1"></i>Ver lista de clientes
            </a>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const salidaForm = document.getElementById('salidaForm');
    const submitSalidaBtn = document.getElementById('submitSalidaBtn');
    const codigoInput = document.querySelector('input[name="codigo"]');
    
    const registroForm = document.getElementById('registroForm');
    const submitRegistroBtn = document.getElementById('submitRegistroBtn');
    
    // Event handlers para el formulario de salida
    if (salidaForm && submitSalidaBtn && codigoInput) {
        // Múltiples event listeners para prevenir envío normal del formulario
        salidaForm.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            procesarSalidaDashboard();
            return false;
        });
        
        // Prevenir envío por Enter
        codigoInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault();
                e.stopPropagation();
                procesarSalidaDashboard();
                return false;
            }
        });
        
        // Click del botón
        submitSalidaBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            procesarSalidaDashboard();
            return false;
        });
        
        // Enfocar automáticamente el campo
        codigoInput.focus();
        
        console.log('Event handlers del dashboard configurados correctamente');
    }
    
    // Event handlers para el formulario de registro
    if (registroForm && submitRegistroBtn) {
        // Múltiples event listeners para prevenir envío normal del formulario
        registroForm.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            procesarRegistroCliente();
            return false;
        });
        
        // Click del botón
        submitRegistroBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            procesarRegistroCliente();
            return false;
        });
        
        console.log('Event handlers del registro configurados correctamente');
        
        // Asegurar que después de cualquier interacción con el formulario de registro,
        // el enfoque regrese al campo principal cuando no se esté escribiendo activamente
        registroForm.addEventListener('focusout', function(e) {
            // Esperar un momento para permitir que el nuevo elemento reciba el enfoque
            setTimeout(() => {
                const activeElement = document.activeElement;
                // Si el enfoque no está en ningún input del formulario de registro, regresar al campo principal
                if (!registroForm.contains(activeElement) && activeElement.tagName !== 'BUTTON') {
                    if (codigoInput) {
                        codigoInput.focus();
                    }
                }
            }, 100);
        });
    }
    
    // Enfocar automáticamente el campo de código para salida al cargar la página
    if (codigoInput) {
        codigoInput.focus();
    }
    
    function procesarSalidaDashboard() {
        const codigo = codigoInput.value.trim();
        
        if (!codigo) {
            Swal.fire({
                icon: 'warning',
                title: 'Campo vacío',
                text: 'Por favor, escanee un código QR o ingrese una cédula/ID',
                background: '#222',
                color: '#0f0',
                confirmButtonColor: '#0f0'
            });
            codigoInput.focus();
            return false;
        }
        
        // Mostrar indicador de carga
        submitSalidaBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Procesando...';
        submitSalidaBtn.disabled = true;
        
        // Enviar petición AJAX
        const formData = new FormData();
        formData.append('codigo', codigo);
        formData.append('ajax', '1');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        console.log('Enviando petición AJAX desde dashboard...');
        
        // Usar XMLHttpRequest para mayor compatibilidad
        const xhr = new XMLHttpRequest();
        xhr.open('POST', window.location.href, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.setRequestHeader('Accept', 'application/json, text/javascript, */*; q=0.01');
        
        xhr.onload = function() {
            console.log('Respuesta recibida:', xhr.status);
            if (xhr.status === 200) {
                try {
                    const data = JSON.parse(xhr.responseText);
                    console.log('Datos recibidos:', data);
                    
                    if (data.success) {
                        // Mostrar SweetAlert de éxito
                        Swal.fire({
                            icon: 'success',
                            title: '¡Salida Registrada Exitosamente!',
                            html: `
                                <div class="text-start" style="color: #0f0;">
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <strong>Cliente:</strong><br>
                                            ${data.cliente.nombre}<br>
                                            <small>Cédula: ${data.cliente.cedula}</small>
                                        </div>
                                        <div class="col-6">
                                            <strong>Vehículo:</strong><br>
                                            ${data.cliente.matricula}<br>
                                            <small>${data.cliente.tipo_vehiculo}</small>
                                        </div>
                                    </div>
                                    <hr style="border-color: #0f0; opacity: 0.3; margin: 1rem 0;">
                                    <div class="row">
                                        <div class="col-4">
                                            <strong>Entrada:</strong><br>
                                            <small>${data.cliente.fecha_entrada}</small>
                                        </div>
                                        <div class="col-4">
                                            <strong>Salida:</strong><br>
                                            <small>${data.cliente.fecha_salida}</small>
                                        </div>
                                        <div class="col-4">
                                            <strong>Tiempo Total:</strong><br>
                                            <small style="color: #ffa500; font-weight: bold;">${data.cliente.tiempo_total}</small>
                                        </div>
                                    </div>
                                </div>
                            `,
                            background: '#222',
                            color: '#0f0',
                            confirmButtonColor: '#0f0',
                            confirmButtonText: 'Procesar Siguiente',
                            width: '600px',
                            showClass: {
                                popup: 'animate__animated animate__fadeInDown'
                            },
                            hideClass: {
                                popup: 'animate__animated animate__fadeOutUp'
                            }
                        }).then(() => {
                            // Limpiar formulario para el siguiente escaneo
                            limpiarFormularioDashboard();
                        });
                    } else {
                        // Mostrar SweetAlert de error
                        Swal.fire({
                            icon: 'error',
                            title: 'No se pudo registrar la salida',
                            text: data.mensaje,
                            background: '#222',
                            color: '#ff4444',
                            confirmButtonColor: '#0f0',
                            confirmButtonText: 'Intentar de nuevo'
                        }).then(() => {
                            codigoInput.value = '';
                            codigoInput.focus();
                            resetSalidaButton();
                        });
                    }
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    console.log('Response text:', xhr.responseText);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de respuesta',
                        text: 'La respuesta del servidor no es válida.',
                        background: '#222',
                        color: '#ff4444',
                        confirmButtonColor: '#0f0',
                        confirmButtonText: 'Reintentar'
                    }).then(() => {
                        resetSalidaButton();
                        codigoInput.focus();
                    });
                }
            } else {
                throw new Error('Error en la respuesta del servidor: ' + xhr.status);
            }
        };
        
        xhr.onerror = function() {
            console.error('Error AJAX:', xhr.statusText);
            Swal.fire({
                icon: 'error',
                title: 'Error de conexión',
                text: 'No se pudo procesar la solicitud. Verifique su conexión e intente nuevamente.',
                background: '#222',
                color: '#ff4444',
                confirmButtonColor: '#0f0',
                confirmButtonText: 'Reintentar'
            }).then(() => {
                resetSalidaButton();
                codigoInput.focus();
            });
        };
        
        xhr.send(formData);
        return false;
    }
    
    function resetSalidaButton() {
        submitSalidaBtn.innerHTML = '<i class="bi bi-box-arrow-right me-2"></i>Registrar Salida';
        submitSalidaBtn.disabled = false;
    }
    
    function limpiarFormularioDashboard() {
        codigoInput.value = '';
        codigoInput.focus();
        resetSalidaButton();
    }
    
    function procesarRegistroCliente() {
        // Validar campos obligatorios
        const matriculaInicio = document.querySelector('input[name="matricula_inicio"]').value.trim();
        const matriculaFin = document.querySelector('input[name="matricula_fin"]').value.trim();
        
        if (!matriculaInicio || !matriculaFin) {
            Swal.fire({
                icon: 'warning',
                title: 'Campo obligatorio',
                text: 'La matrícula es obligatoria. Por favor, complete ambas partes.',
                background: '#222',
                color: '#ffa500',
                confirmButtonColor: '#0f0'
            });
            return false;
        }
        
        if (matriculaInicio.length < 3 || matriculaFin.length < 3) {
            Swal.fire({
                icon: 'warning',
                title: 'Formato incorrecto',
                text: 'Cada parte de la matrícula debe tener exactamente 3 caracteres.',
                background: '#222',
                color: '#ffa500',
                confirmButtonColor: '#0f0'
            });
            return false;
        }
        
        // Mostrar SweetAlert de confirmación
        Swal.fire({
            title: '¿Confirmar registro?',
            html: `
                <div class="text-start" style="color: #0f0;">
                    <p><strong>Matrícula:</strong> ${matriculaInicio}-${matriculaFin}</p>
                    <p><strong>Nombre:</strong> ${document.querySelector('input[name="nombre"]').value || 'No especificado'}</p>
                    <p><strong>Cédula:</strong> ${document.querySelector('input[name="cedula"]').value || 'No especificada'}</p>
                    <p><strong>Teléfono:</strong> ${document.querySelector('input[name="telefono"]').value || 'No especificado'}</p>
                    <p><strong>Tipo de vehículo:</strong> ${document.querySelector('select[name="tipo_vehiculo"]').selectedOptions[0].text}</p>
                </div>
            `,
            icon: 'question',
            background: '#222',
            color: '#0f0',
            confirmButtonColor: '#0f0',
            cancelButtonColor: '#dc3545',
            confirmButtonText: 'Sí, registrar',
            cancelButtonText: 'Cancelar',
            showCancelButton: true
        }).then((result) => {
            if (result.isConfirmed) {
                enviarRegistroCliente();
            }
        });
        
        return false;
    }
    
    function enviarRegistroCliente() {
        // Mostrar indicador de carga
        submitRegistroBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Registrando...';
        submitRegistroBtn.disabled = true;
        
        // Preparar datos del formulario
        const formData = new FormData(registroForm);
        formData.append('ajax', '1');
        
        console.log('Enviando petición AJAX para registro...');
        
        // Usar XMLHttpRequest para mayor compatibilidad
        const xhr = new XMLHttpRequest();
        xhr.open('POST', window.location.href, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.setRequestHeader('Accept', 'application/json, text/javascript, */*; q=0.01');
        
        xhr.onload = function() {
            console.log('Respuesta recibida:', xhr.status);
            if (xhr.status === 200) {
                try {
                    const data = JSON.parse(xhr.responseText);
                    console.log('Datos recibidos:', data);
                    
                    if (data.success) {
                        // Mostrar SweetAlert de éxito con QR
                        const qrImageHtml = data.cliente.qr_url ? 
                            `<div class="text-center my-3">
                                <img src="${data.cliente.qr_url}" alt="Código QR" style="max-width: 250px; border: 2px solid #0f0; background: #fff;">
                                <div class="small mt-2 text-success">¡Código QR generado exitosamente!</div>
                            </div>` : 
                            '<div class="alert alert-warning">QR no disponible.</div>';
                        
                        Swal.fire({
                            icon: 'success',
                            title: '¡Cliente Registrado Exitosamente!',
                            html: `
                                <div class="text-start" style="color: #0f0;">
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <strong>Cliente:</strong><br>
                                            ${data.cliente.nombre}<br>
                                            <small>Cédula: ${data.cliente.cedula}</small>
                                        </div>
                                        <div class="col-6">
                                            <strong>Vehículo:</strong><br>
                                            ${data.cliente.matricula}<br>
                                            <small>${data.cliente.tipo_vehiculo}</small>
                                        </div>
                                    </div>
                                    <hr style="border-color: #0f0; opacity: 0.3; margin: 1rem 0;">
                                    <div class="text-center">
                                        <strong>Fecha de Entrada:</strong><br>
                                        <span style="color: #ffa500; font-weight: bold;">${data.cliente.fecha_entrada}</span>
                                    </div>
                                    ${qrImageHtml}
                                </div>
                            `,
                            background: '#222',
                            color: '#0f0',
                            confirmButtonColor: '#0f0',
                            confirmButtonText: 'Registrar Siguiente',
                            width: '600px',
                            showClass: {
                                popup: 'animate__animated animate__fadeInDown'
                            },
                            hideClass: {
                                popup: 'animate__animated animate__fadeOutUp'
                            }
                        }).then(() => {
                            // Limpiar formulario para el siguiente registro
                            limpiarFormularioRegistro();
                        });
                    } else {
                        // Mostrar SweetAlert de error
                        let errorMsg = data.mensaje;
                        if (data.errors) {
                            errorMsg += '<br><br><strong>Errores:</strong><br>';
                            for (const [field, errors] of Object.entries(data.errors)) {
                                errorMsg += `• ${field}: ${errors.join(', ')}<br>`;
                            }
                        }
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'No se pudo registrar el cliente',
                            html: errorMsg,
                            background: '#222',
                            color: '#ff4444',
                            confirmButtonColor: '#0f0',
                            confirmButtonText: 'Corregir datos'
                        }).then(() => {
                            resetRegistroButton();
                        });
                    }
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    console.log('Response text:', xhr.responseText);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de respuesta',
                        text: 'La respuesta del servidor no es válida.',
                        background: '#222',
                        color: '#ff4444',
                        confirmButtonColor: '#0f0',
                        confirmButtonText: 'Reintentar'
                    }).then(() => {
                        resetRegistroButton();
                    });
                }
            } else {
                throw new Error('Error en la respuesta del servidor: ' + xhr.status);
            }
        };
        
        xhr.onerror = function() {
            console.error('Error AJAX:', xhr.statusText);
            Swal.fire({
                icon: 'error',
                title: 'Error de conexión',
                text: 'No se pudo procesar la solicitud. Verifique su conexión e intente nuevamente.',
                background: '#222',
                color: '#ff4444',
                confirmButtonColor: '#0f0',
                confirmButtonText: 'Reintentar'
            }).then(() => {
                resetRegistroButton();
            });
        };
        
        xhr.send(formData);
        return false;
    }
    
    function resetRegistroButton() {
        submitRegistroBtn.innerHTML = '<i class="bi bi-save me-1"></i>Registrar Cliente';
        submitRegistroBtn.disabled = false;
    }
    
    function limpiarFormularioRegistro() {
        registroForm.reset();
        resetRegistroButton();
        // Enfocar el campo de código para salida después del registro
        if (codigoInput) {
            codigoInput.focus();
        }
    }
});
</script>
{% endblock %}
