{% extends 'app_page/base.html' %}
{% block title %}Panel Principal{% endblock %}

{% block left_section %}
    {# Formulario de salida #}
    <div class="card bg-dark text-success border-success shadow-lg" style="width: 100%; max-width: 480px;">
        <div class="card-body px-5 py-4">
            <h2 class="card-title text-center mb-4">
                <i class="bi bi-box-arrow-right me-2"></i>Registrar Salida
            </h2>
            {% if mensaje_salida %}<div class="alert alert-info">{{ mensaje_salida }}</div>{% endif %}
            <form method="post" id="salidaForm" onsubmit="return false;">
                {% csrf_token %}
                <div class="mb-4">
                    <label for="id_codigo" class="form-label">
                        <i class="bi bi-upc-scan me-2"></i>Escanee el código QR o ingrese la cédula o ID
                    </label>
                    <input type="text" 
                           name="codigo" 
                           id="id_codigo" 
                           class="form-control" 
                           placeholder="Escanee QR o ingrese cédula/ID..."
                           autocomplete="off"
                           autofocus>
                    <div class="form-text text-muted mt-2">
                        <small><i class="bi bi-lightbulb me-1"></i>El campo se enfocará automáticamente para facilitar el escaneo</small>
                    </div>
                </div>
                <button type="submit" class="btn btn-success w-100 py-2" id="submitSalidaBtn">
                    <i class="bi bi-box-arrow-right me-2"></i>Registrar Salida
                </button>
            </form>
        </div>
    </div>

{% endblock %}

{% block right_section %}
    {# Formulario de registro de usuario #}
    <div class="card bg-dark text-success border-success shadow-lg" style="width: 100%; max-width: 480px;">
        <div class="card-body px-5 py-4">
            <h2 class="card-title text-center mb-4">
                <i class="bi bi-person-plus-fill me-2"></i>Registro de Cliente
            </h2>
            <form method="post" action="{% url 'dashboard' %}">
                {% csrf_token %}
                {% for field in registro_form.visible_fields %}
                    {% if field.name == 'matricula_inicio' %}
                        <div class="mb-4">
                            <label class="form-label">Matrícula</label>
                            <div class="input-group">
                                <input type="text" name="matricula_inicio" maxlength="3" minlength="3" class="form-control form-control-sm text-uppercase" style="max-width:60px;" value="{{ registro_form.matricula_inicio.value|default_if_none:'' }}" required>
                                <span class="input-group-text" style="max-width:24px;">-</span>
                                <input type="text" name="matricula_fin" maxlength="3" minlength="3" class="form-control form-control-sm text-uppercase" style="max-width:60px;" value="{{ registro_form.matricula_fin.value|default_if_none:'' }}" required>
                            </div>
                            {% if registro_form.matricula_inicio.help_text %}
                                <div class="form-text text-success">{{ registro_form.matricula_inicio.help_text }}</div>
                            {% endif %}
                            {% for error in registro_form.matricula_inicio.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                            {% for error in registro_form.matricula_fin.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% elif field.name != 'tiempo_parking' and field.name != 'matricula_fin' %}
                        <div class="mb-4">
                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                            {{ field }}
                            {% if field.help_text %}
                                <div class="form-text text-success">{{ field.help_text }}</div>
                            {% endif %}
                            {% for error in field.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endfor %}
                <button type="submit" class="btn btn-success w-100 py-2 mt-2">
                    <i class="bi bi-save me-1"></i>Generar Código de Barras
                </button>
            </form>
            <a href="{% url 'lista_clientes' %}" class="btn btn-dark w-100 py-2 mt-3">
                <i class="bi bi-list-ul me-1"></i>Ver lista de clientes
            </a>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const salidaForm = document.getElementById('salidaForm');
    const submitSalidaBtn = document.getElementById('submitSalidaBtn');
    const codigoInput = document.querySelector('input[name="codigo"]');
    
    if (salidaForm && submitSalidaBtn && codigoInput) {
        // Múltiples event listeners para prevenir envío normal del formulario
        salidaForm.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            procesarSalidaDashboard();
            return false;
        });
        
        // Prevenir envío por Enter
        codigoInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' || e.keyCode === 13) {
                e.preventDefault();
                e.stopPropagation();
                procesarSalidaDashboard();
                return false;
            }
        });
        
        // Click del botón
        submitSalidaBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            procesarSalidaDashboard();
            return false;
        });
        
        // Enfocar automáticamente el campo
        codigoInput.focus();
        
        console.log('Event handlers del dashboard configurados correctamente');
    }
    
    function procesarSalidaDashboard() {
        const codigo = codigoInput.value.trim();
        
        if (!codigo) {
            Swal.fire({
                icon: 'warning',
                title: 'Campo vacío',
                text: 'Por favor, escanee un código QR o ingrese una cédula/ID',
                background: '#222',
                color: '#0f0',
                confirmButtonColor: '#0f0'
            });
            codigoInput.focus();
            return false;
        }
        
        // Mostrar indicador de carga
        submitSalidaBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Procesando...';
        submitSalidaBtn.disabled = true;
        
        // Enviar petición AJAX
        const formData = new FormData();
        formData.append('codigo', codigo);
        formData.append('ajax', '1');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        console.log('Enviando petición AJAX desde dashboard...');
        
        // Usar XMLHttpRequest para mayor compatibilidad
        const xhr = new XMLHttpRequest();
        xhr.open('POST', window.location.href, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.setRequestHeader('Accept', 'application/json, text/javascript, */*; q=0.01');
        
        xhr.onload = function() {
            console.log('Respuesta recibida:', xhr.status);
            if (xhr.status === 200) {
                try {
                    const data = JSON.parse(xhr.responseText);
                    console.log('Datos recibidos:', data);
                    
                    if (data.success) {
                        // Mostrar SweetAlert de éxito
                        Swal.fire({
                            icon: 'success',
                            title: '¡Salida Registrada Exitosamente!',
                            html: `
                                <div class="text-start" style="color: #0f0;">
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <strong>Cliente:</strong><br>
                                            ${data.cliente.nombre}<br>
                                            <small>Cédula: ${data.cliente.cedula}</small>
                                        </div>
                                        <div class="col-6">
                                            <strong>Vehículo:</strong><br>
                                            ${data.cliente.matricula}<br>
                                            <small>${data.cliente.tipo_vehiculo}</small>
                                        </div>
                                    </div>
                                    <hr style="border-color: #0f0; opacity: 0.3; margin: 1rem 0;">
                                    <div class="row">
                                        <div class="col-4">
                                            <strong>Entrada:</strong><br>
                                            <small>${data.cliente.fecha_entrada}</small>
                                        </div>
                                        <div class="col-4">
                                            <strong>Salida:</strong><br>
                                            <small>${data.cliente.fecha_salida}</small>
                                        </div>
                                        <div class="col-4">
                                            <strong>Tiempo Total:</strong><br>
                                            <small style="color: #ffa500; font-weight: bold;">${data.cliente.tiempo_total}</small>
                                        </div>
                                    </div>
                                </div>
                            `,
                            background: '#222',
                            color: '#0f0',
                            confirmButtonColor: '#0f0',
                            confirmButtonText: 'Procesar Siguiente',
                            width: '600px',
                            showClass: {
                                popup: 'animate__animated animate__fadeInDown'
                            },
                            hideClass: {
                                popup: 'animate__animated animate__fadeOutUp'
                            }
                        }).then(() => {
                            // Limpiar formulario para el siguiente escaneo
                            limpiarFormularioDashboard();
                        });
                    } else {
                        // Mostrar SweetAlert de error
                        Swal.fire({
                            icon: 'error',
                            title: 'No se pudo registrar la salida',
                            text: data.mensaje,
                            background: '#222',
                            color: '#ff4444',
                            confirmButtonColor: '#0f0',
                            confirmButtonText: 'Intentar de nuevo'
                        }).then(() => {
                            codigoInput.value = '';
                            codigoInput.focus();
                            resetSalidaButton();
                        });
                    }
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    console.log('Response text:', xhr.responseText);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de respuesta',
                        text: 'La respuesta del servidor no es válida.',
                        background: '#222',
                        color: '#ff4444',
                        confirmButtonColor: '#0f0',
                        confirmButtonText: 'Reintentar'
                    }).then(() => {
                        resetSalidaButton();
                        codigoInput.focus();
                    });
                }
            } else {
                throw new Error('Error en la respuesta del servidor: ' + xhr.status);
            }
        };
        
        xhr.onerror = function() {
            console.error('Error AJAX:', xhr.statusText);
            Swal.fire({
                icon: 'error',
                title: 'Error de conexión',
                text: 'No se pudo procesar la solicitud. Verifique su conexión e intente nuevamente.',
                background: '#222',
                color: '#ff4444',
                confirmButtonColor: '#0f0',
                confirmButtonText: 'Reintentar'
            }).then(() => {
                resetSalidaButton();
                codigoInput.focus();
            });
        };
        
        xhr.send(formData);
        return false;
    }
    
    function resetSalidaButton() {
        submitSalidaBtn.innerHTML = '<i class="bi bi-box-arrow-right me-2"></i>Registrar Salida';
        submitSalidaBtn.disabled = false;
    }
    
    function limpiarFormularioDashboard() {
        codigoInput.value = '';
        codigoInput.focus();
        resetSalidaButton();
    }
});
</script>
{% endblock %}
