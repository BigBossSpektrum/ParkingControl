{% extends 'app_page/base.html' %}
<<<<<<< HEAD
{% block title %}Salida - Escanear QR{% endblock %}
{% block extra_css %}
    <style>
        .scanner-container {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 255, 0, 0.1);
            border: 2px solid #0f0;
        }
        .form-control {
            background: #111;
            border: 2px solid #333;
            color: #0f0;
            font-size: 1.1rem;
            padding: 0.75rem;
            border-radius: 8px;
        }
        .form-control:focus {
            background: #111;
            color: #0f0;
            border-color: #0f0;
            box-shadow: 0 0 0 0.2rem rgba(0,255,0,.15);
        }
        .btn-success {
            background: #0f0;
            color: #000;
            border: none;
            font-weight: bold;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .btn-success:hover {
            background: #00cc00;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.3);
        }
        .btn-warning {
            background: #ffa500;
            color: #000;
            border: none;
            font-weight: bold;
        }
        .btn-outline-success {
            border: 2px solid #0f0;
            color: #0f0;
            background: transparent;
        }
        .btn-outline-success:hover {
            background: #0f0;
            color: #000;
        }
        .scanner-title {
            color: #0f0;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            margin-bottom: 1.5rem;
        }
        .instructions {
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid rgba(0, 255, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .qr-icon {
            font-size: 3rem;
            color: #0f0;
            margin-bottom: 1rem;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="scanner-container">
                <div class="text-center">
                    <i class="bi bi-qr-code-scan qr-icon"></i>
                    <h1 class="scanner-title">Registrar Salida</h1>
                </div>
                
                <div class="instructions">
                    <h6 class="text-success mb-2"><i class="bi bi-info-circle me-2"></i>Instrucciones:</h6>
                    <ul class="mb-0 small text-light">
                        <li>Escanee el código QR del cliente</li>
                        <li>O ingrese manualmente la cédula o ID del cliente</li>
                        <li>Solo se procesarán clientes que estén actualmente en el parking</li>
                    </ul>
                </div>

                <!-- Los mensajes ahora se manejan vía SweetAlert -->

                <form method="post" class="mt-4" id="salidaForm" onsubmit="return false;">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label for="id_codigo" class="form-label text-success">
                            <i class="bi bi-upc-scan me-2"></i>Escanee el código QR o ingrese la cédula o ID
                        </label>
                        <input type="text" 
                               name="codigo" 
                               id="id_codigo" 
                               class="form-control" 
                               placeholder="Escanee QR o ingrese cédula/ID..."
                               autocomplete="off"
                               autofocus>
                        <div class="form-text text-muted mt-2">
                            <small><i class="bi bi-lightbulb me-1"></i>El campo se enfocará automáticamente para facilitar el escaneo</small>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success" id="submitBtn">
                            <i class="bi bi-box-arrow-right me-2"></i>Registrar Salida
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="limpiarFormulario()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Limpiar y Nuevo Escaneo
                        </button>
                    </div>
                </form>

                <div class="text-center mt-4">
                    <a href="{% url 'dashboard' %}" class="btn btn-dark">
                        <i class="bi bi-house me-2"></i>Volver al Dashboard
                    </a>
                    <a href="{% url 'lista_clientes' %}" class="btn btn-dark ms-2">
                        <i class="bi bi-list-ul me-2"></i>Ver Lista de Clientes
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const codigoInput = document.getElementById('id_codigo');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('salidaForm');
    
    // Auto-focus en el campo de código para facilitar el escaneo
    if (codigoInput) {
        codigoInput.focus();
        
        // Auto-submit cuando se detecta un código escaneado (típicamente termina con Enter)
        codigoInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                if (this.value.trim()) {
                    procesarSalida();
                }
                return false; // Seguridad adicional
            }
        });
        
        // Prevenir cualquier envío automático del campo input
        codigoInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        });
        
        // Mostrar indicador cuando hay texto
        codigoInput.addEventListener('input', function() {
            if (this.value.trim()) {
                submitBtn.classList.remove('btn-success');
                submitBtn.classList.add('btn-warning');
                submitBtn.innerHTML = '<i class="bi bi-search me-2"></i>Buscar Cliente';
            } else {
                submitBtn.classList.remove('btn-warning');
                submitBtn.classList.add('btn-success');
                submitBtn.innerHTML = '<i class="bi bi-box-arrow-right me-2"></i>Registrar Salida';
            }
        });
    }
    
    // Múltiples event listeners para prevenir envío normal del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        procesarSalida();
        return false;
    });
    
    // Prevenir envío con onsubmit también
    form.onsubmit = function(e) {
        e.preventDefault();
        e.stopPropagation();
        procesarSalida();
        return false;
    };
    
    function procesarSalida() {
        const codigo = codigoInput.value.trim();
        
        if (!codigo) {
            Swal.fire({
                icon: 'warning',
                title: 'Campo vacío',
                text: 'Por favor, escanee un código QR o ingrese una cédula/ID',
                background: '#222',
                color: '#0f0',
                confirmButtonColor: '#0f0'
            });
            codigoInput.focus();
            return false;
        }
        
        // Mostrar indicador de carga
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Procesando...';
        submitBtn.disabled = true;
        
        // Enviar petición AJAX
        const formData = new FormData();
        formData.append('codigo', codigo);
        formData.append('ajax', '1'); // Parámetro adicional para detectar AJAX
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        console.log('Enviando petición AJAX...'); // Debug
        
        // Usar XMLHttpRequest para mayor compatibilidad con escáneres QR
        const xhr = new XMLHttpRequest();
        xhr.open('POST', window.location.href, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.setRequestHeader('Accept', 'application/json, text/javascript, */*; q=0.01');
        
        xhr.onload = function() {
            console.log('Respuesta recibida:', xhr.status); // Debug
            if (xhr.status === 200) {
                try {
                    const data = JSON.parse(xhr.responseText);
                    console.log('Datos recibidos:', data); // Debug
                    
                    if (data.success) {
                        // Mostrar SweetAlert de éxito con información del cliente
                        Swal.fire({
                            icon: 'success',
                            title: '¡Salida Registrada Exitosamente!',
                            html: `
                                <div class="text-start" style="color: #0f0;">
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <strong>Cliente:</strong><br>
                                            ${data.cliente.nombre}<br>
                                            <small>Cédula: ${data.cliente.cedula}</small>
                                        </div>
                                        <div class="col-6">
                                            <strong>Vehículo:</strong><br>
                                            ${data.cliente.matricula}<br>
                                            <small>${data.cliente.tipo_vehiculo}</small>
                                        </div>
                                    </div>
                                    <hr style="border-color: #0f0; opacity: 0.3; margin: 1rem 0;">
                                    <div class="row">
                                        <div class="col-4">
                                            <strong>Entrada:</strong><br>
                                            <small>${data.cliente.fecha_entrada}</small>
                                        </div>
                                        <div class="col-4">
                                            <strong>Salida:</strong><br>
                                            <small>${data.cliente.fecha_salida}</small>
                                        </div>
                                        <div class="col-4">
                                            <strong>Tiempo Total:</strong><br>
                                            <small style="color: #ffa500; font-weight: bold;">${data.cliente.tiempo_total}</small>
                                        </div>
                                    </div>
                                </div>
                            `,
                            background: '#222',
                            color: '#0f0',
                            confirmButtonColor: '#0f0',
                            confirmButtonText: 'Procesar Siguiente',
                            width: '600px',
                            showClass: {
                                popup: 'animate__animated animate__fadeInDown'
                            },
                            hideClass: {
                                popup: 'animate__animated animate__fadeOutUp'
                            }
                        }).then(() => {
                            // Limpiar formulario para el siguiente escaneo
                            limpiarFormulario();
                        });
                    } else {
                        // Mostrar SweetAlert de error
                        Swal.fire({
                            icon: 'error',
                            title: 'No se pudo registrar la salida',
                            text: data.mensaje,
                            background: '#222',
                            color: '#ff4444',
                            confirmButtonColor: '#0f0',
                            confirmButtonText: 'Intentar de nuevo'
                        }).then(() => {
                            // Enfocar de nuevo el campo y limpiar
                            codigoInput.value = '';
                            codigoInput.focus();
                            resetButton();
                        });
                    }
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    console.log('Response text:', xhr.responseText);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de respuesta',
                        text: 'La respuesta del servidor no es válida. Es posible que no se esté enviando como AJAX.',
                        background: '#222',
                        color: '#ff4444',
                        confirmButtonColor: '#0f0',
                        confirmButtonText: 'Reintentar'
                    }).then(() => {
                        resetButton();
                        codigoInput.focus();
                    });
                }
            } else {
                throw new Error('Error en la respuesta del servidor: ' + xhr.status);
            }
        };
        
        xhr.onerror = function() {
            console.error('Error AJAX:', xhr.statusText); // Debug
            Swal.fire({
                icon: 'error',
                title: 'Error de conexión',
                text: 'No se pudo procesar la solicitud. Verifique su conexión e intente nuevamente.',
                background: '#222',
                color: '#ff4444',
                confirmButtonColor: '#0f0',
                confirmButtonText: 'Reintentar'
            }).then(() => {
                resetButton();
                codigoInput.focus();
            });
        };
        
        xhr.send(formData);
        
        return false; // Asegurar que no hay envío normal
    }
    
    function resetButton() {
        submitBtn.classList.remove('btn-warning');
        submitBtn.classList.add('btn-success');
        submitBtn.innerHTML = '<i class="bi bi-box-arrow-right me-2"></i>Registrar Salida';
        submitBtn.disabled = false;
    }
    
    // Event listeners adicionales para prevenir envío por escáneres QR
    codigoInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Enter key interceptado en keypress');
            procesarSalida();
            return false;
        }
    });
    
    codigoInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Enter key interceptado en keydown');
            procesarSalida();
            return false;
        }
    });
    
    // Event listener para el botón submit
    submitBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Submit button clicked');
        procesarSalida();
        return false;
    });
    
    // Prevenir cualquier tipo de envío del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Form submit interceptado');
        procesarSalida();
        return false;
    }, true); // true para capturar en fase de captura
    
    // Enfocar automáticamente el campo cuando se carga la página
    codigoInput.focus();
    
    // Mostrar en consola que todo está configurado
    console.log('Todos los event listeners configurados para prevenir redirección');
    
    // Función global para el botón limpiar
    window.limpiarFormulario = function() {
        codigoInput.value = '';
        codigoInput.focus();
        resetButton();
    }
});
</script>
=======
{% block title %}Registrar Salida{% endblock %}
{% block content %}
    <h1>Registrar Salida</h1>
    {% if mensaje %}<p><strong>{{ mensaje }}</strong></p>{% endif %}
    <form method="post">
    {{ csrf_token }}
        {{ form|safe }}
        <button type="submit">Registrar Salida</button>
    </form>
    <a href="{% url 'portal_opciones' %}">Volver al portal</a>
>>>>>>> 7395215fdcd9c30411c8dbe2b5120de6ba911bbd
{% endblock %}
