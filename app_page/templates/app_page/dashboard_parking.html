{% extends 'app_page/base.html' %}
{% block title %}Panel Principal{% endblock %}

{% block content %}
<!-- Panel de información del usuario -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">
                        <i class="bi bi-person-circle me-2"></i>
                        Bienvenido, {{ user.get_full_name|default:user.username }}
                    </h5>
                    <small>
                        <i class="bi bi-shield-check me-1"></i>
                        Nivel de acceso: <strong>{{ perfil.get_rol_display }}</strong>
                    </small>
                </div>
                <div class="col-md-6 text-md-end">
                    <small class="text-muted">
                        <i class="bi bi-clock me-1"></i>
                        Sesión iniciada
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        {# Formulario de registro de usuario #}
        <div class="card bg-dark text-success border-success shadow-lg" style="width: 100%; max-width: 480px;">
            <div class="card-body px-5 py-4">
                <h2 class="card-title text-center mb-4">
                    <i class="bi bi-person-plus-fill me-2"></i>Registro de Cliente
                </h2>
                {% if message_success %}<div class="alert alert-success">{{ message_success }}</div>{% endif %}
                {% if mensaje_error %}<div class="alert alert-danger">{{ mensaje_error }}</div>{% endif %}
                <form method="post" id="registroForm" onsubmit="return false;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="registro">
                    <div class="mb-4">
                        <label for="{{ registro_form.cedula.id_for_label }}" class="form-label">
                            <i class="bi bi-card-text me-2"></i>Cédula
                        </label>
                        <input type="text" 
                               name="{{ registro_form.cedula.name }}" 
                               id="{{ registro_form.cedula.id_for_label }}" 
                               class="form-control" 
                               placeholder="Ingrese cédula"
                               required>
                    </div>
                    <div class="mb-4">
                        <label for="{{ registro_form.nombre.id_for_label }}" class="form-label">
                            <i class="bi bi-person-vcard me-2"></i>Nombre
                        </label>
                        <input type="text" 
                               name="{{ registro_form.nombre.name }}" 
                               id="{{ registro_form.nombre.id_for_label }}" 
                               class="form-control" 
                               placeholder="Ingrese nombre completo"
                               required>
                    </div>
                                        <div class="mb-4">
                        <label for="{{ registro_form.tipo_vehiculo.id_for_label }}" class="form-label">
                            <i class="bi bi-truck me-2"></i>Tipo de vehículo
                        </label>
                        <select name="{{ registro_form.tipo_vehiculo.name }}" 
                                id="{{ registro_form.tipo_vehiculo.id_for_label }}" 
                                class="form-control" 
                                required>
                            <option value="">Seleccione tipo de vehículo</option>
                            <option value="Auto">Auto</option>
                            <option value="Moto">Moto</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="{{ registro_form.matricula.id_for_label }}" class="form-label">
                            <i class="bi bi-car-front me-2"></i>Placa del vehículo
                        </label>
                        <input type="text" 
                               name="{{ registro_form.matricula.name }}" 
                               id="{{ registro_form.matricula.id_for_label }}" 
                               class="form-control" 
                               placeholder=""
                               maxlength="10"
                               style="text-transform: uppercase;"
                               oninput="this.value = this.value.toUpperCase()"
                               required>
                    </div>
                    <div class="mb-4">
                        <label for="{{ registro_form.telefono.id_for_label }}" class="form-label">
                            <i class="bi bi-telephone me-2"></i>Teléfono
                        </label>
                        <input type="tel" 
                               name="{{ registro_form.telefono.name }}" 
                               id="{{ registro_form.telefono.id_for_label }}" 
                               class="form-control" 
                               placeholder="Ingrese teléfono">
                    </div>
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="bi bi-building me-2"></i>Ubicación (Opcional)
                        </label>
                        <div class="row">
                            <div class="col-6">
                                <input type="text" 
                                       name="{{ registro_form.torre.name }}" 
                                       id="{{ registro_form.torre.id_for_label }}" 
                                       class="form-control" 
                                       placeholder="Torre"
                                       maxlength="10">
                                <small class="text-muted">Torre</small>
                            </div>
                            <div class="col-6">
                                <input type="text"
                                       name="{{ registro_form.apartamento.name }}"
                                       id="{{ registro_form.apartamento.id_for_label }}"
                                       class="form-control"
                                       placeholder="Apartamento"
                                       maxlength="10">
                                <small class="text-muted">Apartamento</small>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100 py-2" id="submitRegistroBtn">
                        <i class="bi bi-save me-1"></i>Registrar Cliente
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        {# Formulario de salida #}
        <div class="card bg-dark text-success border-success shadow-lg" style="width: 100%; max-width: 480px;">
            <div class="card-body px-5 py-4">
                <h2 class="card-title text-center mb-4">
                    <i class="bi bi-box-arrow-right me-2"></i>Registrar Salida
                </h2>
                {% if mensaje_salida %}<div class="alert alert-info">{{ mensaje_salida }}</div>{% endif %}
                <form method="post" id="salidaForm" onsubmit="return false;">
                    {% csrf_token %}
                <div class="mb-4">
                    <label for="id_codigo" class="form-label">
                        <i class="bi bi-upc-scan me-2"></i>Escanee el código QR o ingrese la cédula o ID
                    </label>
                    <input type="text" 
                           name="codigo" 
                           id="id_codigo" 
                           class="form-control" 
                           placeholder="Escanee QR o ingrese cédula/ID..."
                           autocomplete="off"
                           autofocus>
                    <div class="form-text text-muted mt-2">
                        <small><i class="bi bi-lightbulb me-1"></i>Campo principal del sistema - se enfoca automáticamente para facilitar el escaneo</small>
                    </div>
                </div>
                <button type="submit" class="btn btn-success w-100 py-2" id="submitSalidaBtn">
                    <i class="bi bi-box-arrow-right me-2"></i>Registrar Salida
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Separador visual -->
<hr class="my-5">

<!-- Sección de acciones adicionales -->
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-center gap-3 flex-wrap">
            <a href="{% url 'lista_clientes' %}" class="btn btn-primary">
                <i class="bi bi-list-ul me-2"></i>Ver Lista de Clientes
            </a>
            {% if perfil.es_administrador %}
            <a href="{% url 'admin:index' %}" class="btn btn-secondary">
                <i class="bi bi-gear me-2"></i>Panel de Administración
            </a>
            <a href="{% url 'printer_dashboard' %}" class="btn btn-info">
                <i class="bi bi-printer me-2"></i>Configurar Impresora
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const salidaForm = document.getElementById('salidaForm');
    const registroForm = document.getElementById('registroForm');
    const codigoInput = document.getElementById('id_codigo');
    const cedulaInput = document.querySelector('input[name="cedula"]');
    const submitSalidaBtn = document.getElementById('submitSalidaBtn');
    const submitRegistroBtn = document.getElementById('submitRegistroBtn');
    
    // Función para enfocar automáticamente el campo de código (salida)
    function enfocarCodigo() {
        // No enfocar si hay un modal de SweetAlert2 abierto
        if (document.querySelector('.swal2-container') || document.querySelector('.swal2-shown')) {
            return;
        }
        
        if (codigoInput) {
            codigoInput.focus();
        }
    }
    
    // Enfocar el campo de código al cargar la página
    enfocarCodigo();
    
    // Re-enfocar cuando se pierde el foco (útil para scanners)
    document.addEventListener('click', function(e) {
        // No re-enfocar si hay un modal abierto o si se hizo clic en un modal
        if (document.querySelector('.swal2-container') || 
            e.target.closest('.swal2-container') ||
            e.target.closest('form') || 
            e.target.closest('.alert')) {
            return;
        }
        setTimeout(enfocarCodigo, 100);
    });
    
    // Manejo del formulario de salida
    if (salidaForm) {
        salidaForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitSalida();
        });
    }
    
    // Manejo del formulario de registro
    if (registroForm) {
        registroForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitRegistro();
        });
    }
    
    function submitSalida() {
        const codigo = codigoInput.value.trim();
        
        if (!codigo) {
            Swal.fire({
                icon: 'warning',
                title: 'Campo requerido',
                text: 'Por favor ingrese un código QR o cédula.',
                confirmButtonColor: '#198754'
            });
            return false;
        }
        
        // Cambiar el botón mientras se procesa
        submitSalidaBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Procesando...';
        submitSalidaBtn.disabled = true;
        
        const formData = new FormData(salidaForm);
        formData.append('action', 'salida');
        
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '', true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                resetSalidaButton();
                
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        if (response.success) {
                            // Verificar si necesitamos mostrar confirmación o si ya se registró la salida
                            if (response.mostrar_confirmacion) {
                                // Primera respuesta: mostrar modal de confirmación para cobrar
                                mostrarModalConfirmacion(response.cliente);
                            } else if (response.salida_confirmada) {
                                // Segunda respuesta: salida confirmada y registrada
                                mostrarModalSalidaCompletada(response.cliente);
                            }
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.mensaje || 'Error al procesar la solicitud',
                                confirmButtonColor: '#198754'
                            });
                        }
                    } catch (e) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de respuesta',
                            text: 'Error al procesar la respuesta del servidor',
                            confirmButtonColor: '#198754'
                        });
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de conexión',
                        text: 'Error al conectar con el servidor',
                        confirmButtonColor: '#198754'
                    });
                }
            }
        };
        
        xhr.send(formData);
        return false;
    }
    
    function resetSalidaButton() {
        submitSalidaBtn.innerHTML = '<i class="bi bi-box-arrow-right me-2"></i>Registrar Salida';
        submitSalidaBtn.disabled = false;
    }
    
    function submitRegistro() {
        console.log('submitRegistro called');
        
        // Validar campos requeridos
        const requiredFields = registroForm.querySelectorAll('input[required], select[required]');
        let isValid = true;
        
        console.log('Required fields found:', requiredFields.length);
        
        requiredFields.forEach(field => {
            console.log(`Field ${field.name}: value="${field.value}" valid=${field.value.trim() !== ''}`);
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        console.log('Form is valid:', isValid);
        
        if (!isValid) {
            console.log('Form validation failed');
            Swal.fire({
                icon: 'warning',
                title: 'Campos requeridos',
                text: 'Por favor complete todos los campos obligatorios.',
                confirmButtonColor: '#198754'
            });
            return false;
        }
        
        // Cambiar el botón mientras se procesa
        submitRegistroBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Registrando...';
        submitRegistroBtn.disabled = true;
        
        const formData = new FormData(registroForm);
        
        // Log form data
        console.log('Form data being sent:');
        for (let pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }
        
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '', true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                console.log('AJAX response received. Status:', xhr.status);
                console.log('Response text:', xhr.responseText);
                
                resetRegistroButton();
                
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        console.log('Parsed response:', response);
                        
                        if (response.success) {
                            console.log('Registration successful');
                            
                            // Preparar mensaje con información de impresión
                            let message = response.message;
                            if (response.print_result) {
                                if (response.print_result.success) {
                                    message += '\n\n✅ ' + response.print_result.message;
                                } else {
                                    message += '\n\n⚠️ ' + response.print_result.message;
                                }
                            }
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'Cliente registrado',
                                text: message,
                                confirmButtonColor: '#198754'
                            }).then(() => {
                                limpiarFormularioRegistro();
                                // Actualizar estadísticas si existen
                                location.reload();
                            });
                        } else {
                            console.log('Registration failed:', response.message);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error en el registro',
                                text: response.message || 'Error al registrar el cliente',
                                confirmButtonColor: '#198754'
                            });
                        }
                    } catch (e) {
                        console.error('Error parsing JSON response:', e);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de respuesta',
                            text: 'Error al procesar la respuesta del servidor',
                            confirmButtonColor: '#198754'
                        });
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de conexión',
                        text: 'Error al conectar con el servidor',
                        confirmButtonColor: '#198754'
                    });
                }
            }
        };
        
        xhr.onerror = function() {
            resetRegistroButton();
            Swal.fire({
                icon: 'error',
                title: 'Error de red',
                text: 'Error de conexión de red',
                confirmButtonColor: '#198754'
            });
        };
        
        xhr.send(formData);
        return false;
    }
    
    function resetRegistroButton() {
        submitRegistroBtn.innerHTML = '<i class="bi bi-save me-1"></i>Registrar Cliente';
        submitRegistroBtn.disabled = false;
    }
    
    function limpiarFormularioRegistro() {
        registroForm.reset();
        resetRegistroButton();
        // Enfocar el campo de código para salida después del registro exitoso
        if (codigoInput) {
            codigoInput.focus();
        }
    }
    
    // Funciones para el nuevo flujo de salida con confirmación
    function mostrarModalConfirmacion(cliente) {
        const tipoTarifa = cliente.es_tarifa_plena ? 'Tarifa Plena (Costo Fijo)' : 'Tarifa por Minutos';
        
        Swal.fire({
            icon: 'info',
            title: '💰 Confirmar Pago',
            html: `
                <div class="text-start">
                    <h5 class="text-success mb-3">Información del Cliente:</h5>
                    <p><strong>Nombre:</strong> ${cliente.nombre}</p>
                    <p><strong>Cédula:</strong> ${cliente.cedula}</p>
                    <p><strong>Matrícula:</strong> ${cliente.matricula}</p>
                    <p><strong>Tipo:</strong> ${cliente.tipo_vehiculo}</p>
                    <hr>
                    <h5 class="text-info mb-3">Tiempo y Costo:</h5>
                    <p><strong>Entrada:</strong> ${cliente.fecha_entrada}</p>
                    <p><strong>Salida Estimada:</strong> ${cliente.fecha_salida_estimada}</p>
                    <p><strong>Tiempo Total:</strong> ${cliente.tiempo_total}</p>
                    <p><strong>Modalidad:</strong> ${tipoTarifa}</p>
                    <hr>
                    <div class="alert alert-warning text-center">
                        <h4 class="mb-2">💰 Total a Cobrar:</h4>
                        <h2 class="text-danger mb-0">${cliente.costo_formateado}</h2>
                    </div>
                    <div class="alert alert-info">
                        <small><i class="fas fa-info-circle me-1"></i>
                        Confirme después de haber cobrado el monto para registrar la salida definitivamente.</small>
                    </div>
                </div>
            `,
            confirmButtonText: 'Pago Confirmado - Registrar Salida',
            confirmButtonColor: '#198754',
            showCancelButton: true,
            cancelButtonText: 'Cancelar',
            cancelButtonColor: '#6c757d',
            width: '600px',
            allowOutsideClick: false,
            focusConfirm: true,
            customClass: {
                popup: 'text-dark'
            },
            didOpen: () => {
                // Asegurar que el foco esté en el botón de confirmar
                const confirmButton = Swal.getConfirmButton();
                if (confirmButton) {
                    confirmButton.focus();
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // Enviar confirmación de salida
                confirmarSalida(cliente.id);
            } else {
                // Si se cancela, re-enfocar el campo de código después de un delay
                setTimeout(() => {
                    enfocarCodigo();
                }, 100);
            }
        });
    }
    
    function mostrarModalSalidaCompletada(cliente) {
        const tipoTarifa = cliente.es_tarifa_plena ? 'Tarifa Plena (Costo Fijo)' : 'Tarifa por Minutos';
        
        Swal.fire({
            icon: 'success',
            title: '✅ Salida Registrada Exitosamente',
            html: `
                <div class="text-start">
                    <h5 class="text-success mb-3">Información del Cliente:</h5>
                    <p><strong>Nombre:</strong> ${cliente.nombre}</p>
                    <p><strong>Cédula:</strong> ${cliente.cedula}</p>
                    <p><strong>Matrícula:</strong> ${cliente.matricula}</p>
                    <p><strong>Tipo:</strong> ${cliente.tipo_vehiculo}</p>
                    <hr>
                    <h5 class="text-info mb-3">Tiempo y Costo Final:</h5>
                    <p><strong>Entrada:</strong> ${cliente.fecha_entrada}</p>
                    <p><strong>Salida:</strong> ${cliente.fecha_salida}</p>
                    <p><strong>Tiempo Total:</strong> ${cliente.tiempo_total}</p>
                    <p><strong>Modalidad:</strong> ${tipoTarifa}</p>
                    <hr>
                    <div class="alert alert-success text-center">
                        <h4 class="mb-2">✅ Pagado:</h4>
                        <h2 class="text-success mb-0">${cliente.costo_formateado}</h2>
                    </div>
                </div>
            `,
            confirmButtonText: 'Cerrar',
            confirmButtonColor: '#198754',
            width: '600px',
            allowOutsideClick: false,
            focusConfirm: true,
            customClass: {
                popup: 'text-dark'
            },
            didOpen: () => {
                // Asegurar que el foco esté en el botón de cerrar
                const confirmButton = Swal.getConfirmButton();
                if (confirmButton) {
                    confirmButton.focus();
                }
            }
        }).then(() => {
            salidaForm.reset();
            // Re-enfocar el campo de código después de un delay
            setTimeout(() => {
                enfocarCodigo();
            }, 100);
            // Actualizar estadísticas si existen
            location.reload();
        });
    }
    
    function confirmarSalida(clienteId) {
        // Mostrar spinner
        Swal.fire({
            title: 'Registrando Salida...',
            text: 'Procesando la salida del cliente',
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading()
            }
        });
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        formData.append('confirmar_salida', 'true');
        formData.append('cliente_id', clienteId);
        
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '', true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        
                        if (response.success && response.salida_confirmada) {
                            mostrarModalSalidaCompletada(response.cliente);
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: response.mensaje || 'Error al confirmar la salida',
                                confirmButtonColor: '#198754',
                                allowOutsideClick: false,
                                focusConfirm: true
                            }).then(() => {
                                setTimeout(() => {
                                    enfocarCodigo();
                                }, 100);
                            });
                        }
                    } catch (e) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de respuesta',
                            text: 'Error al procesar la respuesta del servidor',
                            confirmButtonColor: '#198754',
                            allowOutsideClick: false,
                            focusConfirm: true
                        }).then(() => {
                            setTimeout(() => {
                                enfocarCodigo();
                            }, 100);
                        });
                    }
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de conexión',
                        text: 'Error al conectar con el servidor',
                        confirmButtonColor: '#198754',
                        allowOutsideClick: false,
                        focusConfirm: true
                    }).then(() => {
                        setTimeout(() => {
                            enfocarCodigo();
                        }, 100);
                    });
                }
            }
        };
        
        xhr.send(formData);
    }
});
</script>
{% endblock %}
