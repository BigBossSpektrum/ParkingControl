{% extends 'app_page/base.html' %}
{% block title %}Registro del Cliente{% endblock %}
{% block content %}
<div class="container py-4">
    <h1 class="mb-4">Registro del Cliente</h1>
    <div class="card bg-dark text-success mb-4" style="max-width: 500px; margin:auto;">
        <div class="card-body">
            <h5 class="card-title">{{ cliente.nombre }} ({{ cliente.cedula }})</h5>
            <p class="card-text"><b>Teléfono:</b> {{ cliente.telefono }}</p>
            <p class="card-text"><b>Matrícula:</b> {{ cliente.matricula }}</p>
            <p class="card-text"><b>Tipo de Vehículo:</b> {{ cliente.get_tipo_vehiculo_display }}</p>
            <p class="card-text"><b>Fecha Entrada:</b> {{ cliente.fecha_entrada|date:'Y-m-d H:i' }}</p>
            <p class="card-text"><b>Fecha Salida:</b> {{ cliente.fecha_salida|date:'Y-m-d H:i' }}</p>
            <p class="card-text"><b>Tiempo en Parking:</b> {{ cliente.tiempo_formateado }}</p>
            {% if user.perfil.es_administrador %}
                <hr class="text-success">
                <h6 class="text-warning">Información de Tarifa (Solo Administrador)</h6>
                <p class="card-text text-warning"><b>Tarifa Completa:</b> {{ cliente.tarifa_completa }}</p>
                <p class="card-text text-info"><b>Tarifa Base ({{ cliente.get_tipo_vehiculo_display }}):</b> {{ cliente.costo_por_tiempo_formateado }}</p>
                <p class="card-text text-muted"><b>Desglose:</b> {{ cliente.costo_formateado }} total - {{ cliente.tiempo_por_costo_formateado }}</p>
            {% endif %}
            <div class="row">
                <div class="col-12 text-center my-3">
                    {% if cliente.qr_image %}
                        <img src="{{ cliente.qr_image.url }}" alt="QR del cliente con datos" style="max-width: 300px; border:2px solid #0f0; background:#fff;"/>
                        <div class="small mt-2">Código QR con datos del cliente</div>
                    {% else %}
                        <div class="alert alert-warning">No hay QR generado para este cliente.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="text-center">
        <a href="{% url 'lista_clientes' %}" class="btn btn-dark me-2">
            <i class="fas fa-arrow-left"></i> Volver a la lista
        </a>
        <button id="reimprimir-ticket" class="btn btn-primary" onclick="reimprimirTicket({{ cliente.id }}, '{{ cliente.nombre|escapejs }}')">
            <i class="fas fa-print"></i> Reimprimir Ticket
        </button>
    </div>
</div>

<!-- JavaScript para la funcionalidad de reimpresión -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function reimprimirTicket(clienteId, nombreCliente) {
    Swal.fire({
        title: '¿Reimprimir ticket?',
        text: `Se imprimirá nuevamente el ticket para ${nombreCliente}`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="fas fa-print"></i> Sí, reimprimir',
        cancelButtonText: 'Cancelar',
        showLoaderOnConfirm: true,
        preConfirm: () => {
            return fetch(`/impresora/print/${clienteId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .catch(error => {
                Swal.showValidationMessage(`Error: ${error.message}`);
            });
        },
        allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
        if (result.isConfirmed && result.value) {
            if (result.value.success) {
                Swal.fire({
                    title: '¡Ticket Enviado!',
                    text: result.value.message,
                    icon: 'success',
                    timer: 3000,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    title: 'Error',
                    text: result.value.message || 'Error al reimprimir el ticket',
                    icon: 'error'
                });
            }
        }
    });
}
</script>
{% endblock %}
